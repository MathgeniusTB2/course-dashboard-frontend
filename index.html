<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Assessment Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #f5f7fa;
            --card-bg: #fff;
            --text: #333;
            --accent: #3498db;
            --accent-dark: #2980b9;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --danger-dark: #c0392b;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --card-shadow: 0 8px 30px rgba(0,0,0,0.12);
            --header-bg: #3498db;
            --header-text: #fff;
            --tag-type-bg: #e3f2fd;
            --tag-type-text: #1976d2;
            --tag-individual-bg: #e8f5e9;
            --tag-individual-text: #388e3c;
            --tag-group-bg: #fff3e0;
            --tag-group-text: #e65100;
            --prereq-bg: #f8f9fa;
            --neon-blue: #00eaff;
            --neon-green: #39ff14;
            --neon-pink: #ff4fff;
            --neon-orange: #ffb86c;
            --neon-yellow: #ffe347;
            --neon-purple: #a259ff;
            --neon-red: #ff4f4f;
            --transition-speed: 0.3s;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
                         Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text);
            background-color: var(--bg);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .dark-theme {
            --bg: #15181e;
            --card-bg: #23262e;
            --text: #e3e8f0;
            --accent: #5ecbfa;
            --accent-dark: #1976d2;
            --secondary: #43e97b;
            --danger: #ff5c5c;
            --danger-dark: #c0392b;
            --shadow: 0 4px 20px rgba(0,0,0,0.5);
            --card-shadow: 0 8px 30px rgba(0,0,0,0.6);
            --header-bg: #23262e;
            --header-text: #e3e8f0;
            --tag-type-bg: #22304a;
            --tag-type-text: #5ecbfa;
            --tag-individual-bg: #1e2e22;
            --tag-individual-text: #39ff14;
            --tag-group-bg: #3a232e;
            --tag-group-text: #ffb4d4;
            --prereq-bg: #23262e;
        }
        
        header {
            text-align: center;
            padding: 20px 0 40px;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2.4rem;
            margin-bottom: 10px;
            font-weight: 800;
            letter-spacing: -0.5px;
            transition: color var(--transition-speed);
        }
        
        .dark-theme h1 {
            color: #e3e8f0;
            text-shadow: 0 2px 8px rgba(17, 17, 17, 0.5);
        }
        
        .app-description {
            max-width: 600px;
            margin: 0 auto 20px;
            color: #64748b;
            font-size: 1rem;
            line-height: 1.6;
        }
        
        .dark-theme .app-description {
            color: #94a3b8;
        }
        
        #fetchBtn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--secondary);
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 14px rgba(46, 204, 113, 0.4);
            border: none;
            margin: 0 auto;
        }
        
        #fetchBtn:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.5);
        }
        
        #fetchBtn:active {
            transform: translateY(0);
        }
        
        #fetchBtn i {
            margin-right: 8px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .filter-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: background var(--transition-speed), box-shadow var(--transition-speed);
        }
        
        .filter-section h3 {
            margin-top: 0;
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            transition: color var(--transition-speed);
        }
        
        .filter-section h3 i {
            margin-right: 8px;
            opacity: 0.8;
        }
        
        .search-input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            font-size: 15px;
            transition: border var(--transition-speed), background var(--transition-speed), color var(--transition-speed);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .dark-theme .search-input {
            background: #181c22;
            color: #e3e8f0;
            border: 1px solid #333a47;
        }
        
        .filter-pill {
            display: inline-flex;
            align-items: center;
            border-radius: 20px;
            padding: 6px 16px;
            margin: 4px 8px 4px 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: 2px solid transparent;
            background: #f0f8ff;
            color: var(--accent);
            transition: all 0.2s;
            user-select: none;
        }
        
        .filter-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .filter-pill.included {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        
        .filter-pill.excluded {
            background: var(--danger);
            color: #fff;
            border-color: var(--danger);
        }
        
        .filter-pill .pill-x {
            margin-left: 8px;
            font-weight: bold;
            font-size: 15px;
            pointer-events: none;
        }
        
        .dark-theme .filter-pill {
            background: #1e293b;
            color: #4fc3f7;
        }
        
        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            background-color: var(--accent-dark);
            transform: translateY(-2px);
        }
        
        button i {
            margin-right: 6px;
        }
        
        .clear-filters {
            background-color: var(--danger);
            margin-top: 15px;
            width: 100%;
        }
        
        .clear-filters:hover {
            background-color: var(--danger-dark);
        }
        
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }
        
        .course-card {
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.4s;
            border: 2px solid transparent;
            position: relative;
        }
        
        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 16px 40px rgba(0,0,0,0.15);
        }
        
        .dark-theme .course-card:hover {
            box-shadow: 0 16px 40px rgba(0,0,0,0.6);
        }
        
        .card-header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        .card-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
        }
        
        .card-header p {
            margin: 6px 0 0;
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .prerequisites {
            background-color: var(--prereq-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            border-left: 4px solid var(--accent);
            transition: background-color var(--transition-speed);
        }
        
        .prerequisites strong {
            color: var(--accent);
            font-weight: 600;
        }
        
        .assessment-item {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
            transition: border-color var(--transition-speed);
        }
        
        .dark-theme .assessment-item {
            border-bottom: 1px solid #232b3a;
        }
        
        .assessment-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .assessment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .assessment-title {
            font-weight: 600;
            color: #2c3e50;
            transition: color var(--transition-speed);
        }
        
        .dark-theme .assessment-title {
            color: #e3e8f0;
        }
        
        .assessment-weight {
            background: #f1c40f;
            color: #7f5200;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        
        .assessment-intent {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #6b7280;
            margin: 6px 0;
            font-style: italic;
            flex-wrap: wrap;
            transition: color var(--transition-speed);
        }
        
        .dark-theme .assessment-intent {
            color: #94a3b8;
        }
        
        .assessment-details {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        .tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .tag-type {
            background: var(--tag-type-bg);
            color: var(--tag-type-text);
        }
        
        .tag-individual {
            background: var(--tag-individual-bg);
            color: var(--tag-individual-text);
        }
        
        .tag-group {
            background: var(--tag-group-bg);
            color: var(--tag-group-text);
        }
        
        .dark-theme .tag-type {
            background: transparent;
            color: var(--neon-blue);
            text-shadow: 0 0 6px var(--neon-blue), 0 0 2px #fff;
            box-shadow: 0 0 8px 2px var(--neon-blue);
            border: 1.5px solid var(--neon-blue);
        }
        
        .dark-theme .tag-individual {
            background: transparent;
            color: var(--neon-green);
            text-shadow: 0 0 6px var(--neon-green), 0 0 2px #fff;
            box-shadow: 0 0 8px 2px var(--neon-green);
            border: 1.5px solid var(--neon-green);
        }
        
        .dark-theme .tag-group {
            background: transparent;
            color: var(--neon-orange);
            text-shadow: 0 0 6px var(--neon-orange), 0 0 2px #fff;
            box-shadow: 0 0 8px 2px var(--neon-orange);
            border: 1.5px solid var(--neon-orange);
        }
        
        .length-pill {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            background: #e9ecef;
            color: #6c757d;
            font-size: 11px;
            font-weight: 500;
            vertical-align: baseline;
            opacity: 0.85;
            transition: all 0.2s;
        }
        
        .dark-theme .length-pill {
            background: #23262e;
            color: #b0b8c1;
            border: none;
            box-shadow: none;
            opacity: 0.7;
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 0;
            color: #7f8c8d;
            grid-column: 1 / -1;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #cbd5e1;
        }
        
        .empty-state h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: #64748b;
        }
        
        .empty-state p {
            max-width: 400px;
            margin: 0 auto;
            color: #94a3b8;
        }
        
        .dark-theme .empty-state i {
            color: #334155;
        }
        
        .dark-theme .empty-state h3 {
            color: #cbd5e1;
        }
        
        .dark-theme .empty-state p {
            color: #94a3b8;
        }
        
        /* Course card backgrounds and themes */
        /* Light mode */
        .course-card[data-work="Individual"] {
            background: linear-gradient(135deg, #e8f5e9 80%, #fff 100%);
            border-color: rgba(57, 255, 20, 0.2);
        }
        
        .course-card[data-work^="Group"] {
            background: linear-gradient(135deg, #fff3e0 80%, #fff 100%);
            border-color: rgba(255, 184, 108, 0.2);
        }
        
        .course-card[data-work="Presentation"] {
            background: linear-gradient(135deg, #f3e0ff 80%, #fff 100%);
            border-color: rgba(162, 89, 255, 0.2);
        }
        
        .course-card[data-work="Examination"] {
            background: linear-gradient(135deg, #fffde7 80%, #fff 100%);
            border-color: rgba(255, 227, 71, 0.2);
        }

        /* Dark mode */
        .dark-theme .course-card[data-work="Individual"] {
            background: linear-gradient(135deg, #1e2e22 80%, #23262e 100%);
            border-color: var(--neon-green);
            box-shadow: 0 0 16px 0 rgba(57, 255, 20, 0.3), var(--shadow);
        }
        
        .dark-theme .course-card[data-work^="Group"] {
            background: linear-gradient(135deg, #2d2320 80%, #23262e 100%);
            border-color: var(--neon-orange);
            box-shadow: 0 0 16px 0 rgba(255, 184, 108, 0.3), var(--shadow);
        }
        
        .dark-theme .course-card[data-work="Presentation"] {
            background: linear-gradient(135deg, #2a1a38 80%, #23262e 100%);
            border-color: var(--neon-purple);
            box-shadow: 0 0 16px 0 rgba(162, 89, 255, 0.3), var(--shadow);
        }
        
        .dark-theme .course-card[data-work="Examination"] {
            background: linear-gradient(135deg, #2a2a1a 80%, #23262e 100%);
            border-color: var(--neon-yellow);
            box-shadow: 0 0 16px 0 rgba(255, 227, 71, 0.3), var(--shadow);
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 40px 0;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(52, 152, 219, 0.2);
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        .loading-progress {
            margin-top: 20px;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .loading-spinner #loadingStatus {
            color: var(--text);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .loading-spinner .progress-container {
            width: 100%;
            height: 6px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
        }

        .dark-theme .loading-spinner .progress-container {
            background: #2a2d35;
        }

        .loading-spinner .progress-bar {
            height: 100%;
            width: 0;
            background: var(--accent);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loading-errors {
            margin: 10px 0;
            color: var(--danger);
            font-size: 14px;
        }
        
        .loading-errors .error-item {
            background: rgba(231, 76, 60, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 4px 0;
        }
        
        .dark-theme .loading-errors .error-item {
            background: rgba(255, 92, 92, 0.1);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Theme toggle button */
        #themeToggle {
            position: relative;
            width: 100%;
            cursor: pointer;
            overflow: hidden;
        }
        
        #themeToggle i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        /* Media queries for better responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .card-container {
                grid-template-columns: 1fr;
            }
            
            .filter-pill {
                padding: 5px 12px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }
            
            #fetchBtn {
                width: 100%;
            }
            
            .filter-section {
                padding: 15px;
            }
        }

        .import-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            max-width: 500px;
            width: 90%;
            z-index: 1000;
        }
        .import-dialog textarea {
            width: 100%;
            min-height: 150px;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: monospace;
            resize: vertical;
        }
        .dark-theme .import-dialog textarea {
            background: #181c22;
            color: #e3e8f0;
            border-color: #333a47;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
            z-index: 999;
        }
        .progress-container {
            width: 300px;
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin: 0 auto;
            overflow: hidden;
        }
        .dark-theme .progress-container {
            background: #2a2d35;
        }
        .progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
        }
        .import-help {
            font-size: 13px;
            color: #666;
            margin: 10px 0;
            line-height: 1.4;
        }
        .dark-theme .import-help {
            color: #b0b8c1;
        }
        .loading-status {
            font-size: 14px;
            color: #64748b;
            margin: 15px 0;
            font-weight: 500;
        }
        .dark-theme .loading-status {
            color: #94a3b8;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--card-bg);
            margin: 40px auto;
            padding: 25px;
            border-radius: 12px;
            max-width: 800px;
            position: relative;
            box-shadow: var(--card-shadow);
            transition: background var(--transition-speed);
        }

        .modal-header {
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 15px;
        }

        .dark-theme .modal-header {
            border-bottom-color: rgba(255,255,255,0.1);
        }

        .modal-close {
            position: absolute;
            right: 20px;
            top: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text);
            padding: 5px;
            transition: color var(--transition-speed);
        }

        .modal-close:hover {
            color: var(--danger);
            transform: none;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .detail-list {
            list-style: none;
            padding: 0;
        }

        .detail-list li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .loading-placeholder {
            text-align: center;
            color: var(--text);
            opacity: 0.6;
            font-style: italic;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Course Assessment Dashboard</h1>
            <p class="app-description">Analyze and track assessment details across your university courses. Filter by assessment types, work requirements, and search for specific courses.</p>
            <button id="fetchBtn"><i class="fas fa-download"></i> Import Courses</button>
        </header>
        
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <div class="loading-progress">
                <p id="loadingStatus">Loading your courses...</p>
                <div id="loadingErrors" class="loading-errors"></div>
                <div class="progress-container">
                    <div class="progress-bar" id="loadingProgress"></div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="filter-section">
                <h3><i class="fas fa-clipboard-list"></i> Assessment Types</h3>
                <div class="checkbox-container" id="assessmentTypeFilters"></div>
            </div>
            
            <div class="filter-section">
                <h3><i class="fas fa-users"></i> Work Types</h3>
                <div class="checkbox-container" id="workTypeFilters"></div>
            </div>
            
            <div class="filter-section">
                <h3><i class="fas fa-search"></i> Search</h3>
                <input type="text" id="searchInput" class="search-input" placeholder="Search by course name or code...">
                <button class="clear-filters" id="clearFilters"><i class="fas fa-times"></i> Clear Filters</button>
            </div>
            
            <div class="filter-section">
                <h3><i class="fas fa-palette"></i> Theme</h3>
                <button id="themeToggle"><i class="fas fa-moon"></i> Dark Mode</button>
            </div>
        </div>
        
        <div class="card-container" id="courseContainer">
            <!-- Cards will be populated here -->
        </div>
    </div>
    <div id="importDialog" class="import-dialog" style="display:none;">
        <h3>Import Courses</h3>
        <div class="import-help">
            <p>Paste your course list below. The system will automatically extract course codes (5-digit numbers) from any text format, including:</p>
            <ul>
                <li>Handbook pages</li>
                <li>Course lists</li>
                <li>Study planners</li>
                <li>Plain text with course codes</li>
            </ul>
        </div>
        <textarea id="importText" placeholder="Example:
Autumn session
33130 Mathematics 1     6cp
41039 Programming 1     6cp
..."></textarea>
        <div class="progress-container" style="display:none;">
            <div class="progress-bar"></div>
        </div>
        <button onclick="processImport()">Import</button>
        <button onclick="closeImport()" style="background:#666">Cancel</button>
    </div>
    <div id="importOverlay" class="overlay" style="display:none;"></div>

    <!-- Course Detail Modal -->
    <div id="courseDetailModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalContent">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
    let courses = [];
    // Filter state: Map<filterName, 0|1|-1> (0=neutral, 1=include, -1=exclude)
    let assessmentTypeFilterState = new Map();
    let workTypeFilterState = new Map();

    const BACKEND_URL = "https://course-dashboard-backend.onrender.com";

    async function fetchAndInit(codes) {
        const spinner = document.getElementById('loadingSpinner');
        const status = document.getElementById('loadingStatus');
        const progress = document.getElementById('loadingProgress');
        const errorsDiv = document.getElementById('loadingErrors');
        
        spinner.style.display = 'block';
        progress.style.width = '0%';
        progress.style.transition = 'width 0.5s ease-out';
        errorsDiv.innerHTML = '';
        let errors = [];
        let successfulCourses = [];
        
        try {
            const resp = await fetch(`${BACKEND_URL}/api/courses`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ subject_codes: codes })
            });

            if (!resp.ok) {
                throw new Error(`HTTP error! status: ${resp.status}`);
            }

            const reader = resp.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let lastPercentage = 0;

            while (true) {
                const {value, done} = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, {stream: true});
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line in buffer
                
                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const data = JSON.parse(line);
                        
                        if (data.type === 'progress') {
                            // Calculate percentage
                            const percentage = Math.round((data.current / data.total) * 100);
                            
                            // Only update if percentage has increased
                            if (percentage > lastPercentage) {
                                lastPercentage = percentage;
                                requestAnimationFrame(() => {
                                    progress.style.width = `${percentage}%`;
                                });
                            }
                            
                            // Update status message
                            if (data.status === 'fetching') {
                                status.textContent = `Fetching ${data.code} (${data.current}/${data.total})`;
                            } else {
                                status.textContent = `Processed ${data.code} (${data.current + 1}/${data.total})`;
                            }
                            
                            if (data.status === 'error') {
                                errors.push(`${data.code}: ${data.error || 'Failed to fetch'}`);
                                errorsDiv.innerHTML = errors.map(err => 
                                    `<div class="error-item">${err}</div>`
                                ).join('');
                            }
                        }
                        else if (data.type === 'complete') {
                            // Process successful courses
                            successfulCourses = data.results
                                .filter(c => !c.error)
                                .map(c => ({
                                    code: c.code,
                                    name: c.title,
                                    prerequisites: c.requisites,
                                    assessments: (c.assessment || []).map(a => ({
                                        name: a.title,
                                        type: a.details.Type || 'Unknown',
                                        groupwork: determineGroupwork(a.details.Groupwork),
                                        weight: parseInt((a.details.Weight || '0').replace(/%/g, ''), 10) || 0,
                                        length: a.details.Length || 'Not specified',
                                        intent: a.details.Intent || ''
                                    }))
                                }));
                            
                            // Update global courses array and initialize dashboard
                            courses = successfulCourses;
                            if (courses.length > 0) {
                                initializeDashboard();
                            }
                        }
                    } catch (e) {
                        console.error('Error processing message:', e, 'Line:', line);
                    }
                }
            }
            
            // Show final status
            status.textContent = `Loaded ${successfulCourses.length} courses` + 
                (errors.length ? ` (${errors.length} failed)` : '');
                
        } catch (e) {
            console.error('Fetch error:', e);
            status.textContent = 'Failed to fetch courses';
            errorsDiv.innerHTML = `<div class="error-item">Network error: ${e.message}</div>`;
        } finally {
            // Keep errors visible longer if there are any
            setTimeout(() => {
                if (errors.length === 0) {
                    spinner.style.display = 'none';
                } else {
                    setTimeout(() => {
                        spinner.style.display = 'none';
                    }, 3000);
                }
            }, 500);
        }
    }

    // Helper function to determine groupwork status
    function determineGroupwork(groupworkText) {
        if (!groupworkText) return 'Individual';
        
        groupworkText = groupworkText.toLowerCase();
        if (groupworkText.includes('individual') || groupworkText === 'no') {
            return 'Individual';
        } else if (groupworkText.includes('group') || 
                groupworkText.includes('team') || 
                groupworkText.includes('pair')) {
            return 'Group';
        }
        
        // Try to get group size if specified
        const sizeMatch = groupworkText.match(/\d+/);
        if (sizeMatch) {
            return `Group (${sizeMatch[0]})`;
        }
        
        return groupworkText;
    }

    document.getElementById('fetchBtn').addEventListener('click', () => {
        document.getElementById('importDialog').style.display = '';
        document.getElementById('importOverlay').style.display = '';
    });

    function closeImport() {
        document.getElementById('importDialog').style.display = 'none';
        document.getElementById('importOverlay').style.display = 'none';
        document.getElementById('importText').value = '';
    }

    async function processImport() {
        const input = document.getElementById('importText').value;
        if (!input) return;

        // Extract all 5-digit numbers from any text
        const codes = [...new Set(input.match(/\b\d{5}\b/g))];
        
        if (codes.length === 0) {
            alert('No valid course codes found. Course codes are 5-digit numbers.');
            return;
        }

        closeImport();
        
        const progressContainer = document.querySelector('.progress-container');
        const progressBar = document.querySelector('.progress-bar');
        progressContainer.style.display = '';
        
        let progress = 0;
        const updateProgress = () => {
            progress += (100 - progress) * 0.1;
            progressBar.style.width = `${progress}%`;
        };
        
        const progressInterval = setInterval(updateProgress, 100);
        
        try {
            await fetchAndInit(codes);
        } finally {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            setTimeout(() => {
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
            }, 500);
        }
    }

    function initializeDashboard() {
        renderFilters();
        renderCourses();
    }

    function renderFilters() {
        console.log('renderFilters called with courses:', courses); // Debug log
        const assessmentTypeFilters = document.getElementById('assessmentTypeFilters');
        const workTypeFilters = document.getElementById('workTypeFilters');
        const allAssessmentTypes = new Set();
        const allWorkTypes = new Set();

        courses.forEach(course => {
            course.assessments.forEach(a => {
                allAssessmentTypes.add(a.type);
                allWorkTypes.add(a.groupwork);
            });
        });

        console.log('Found assessment types:', Array.from(allAssessmentTypes)); // Debug log
        console.log('Found work types:', Array.from(allWorkTypes)); // Debug log

        function createPill(label, filterMap, container) {
            let state = filterMap.get(label) || 0;
            const pill = document.createElement('span');
            pill.className = 'filter-pill';
            if (state === 1) pill.classList.add('included');
            if (state === -1) pill.classList.add('excluded');
            pill.tabIndex = 0;
            pill.textContent = label;
            if (state === -1) {
                const x = document.createElement('span');
                x.className = 'pill-x';
                x.textContent = 'âœ•';
                pill.appendChild(x);
            }
            pill.addEventListener('click', () => {
                // Cycle: 0 -> 1 -> -1 -> 0
                let newState = state === 0 ? 1 : (state === 1 ? -1 : 0);
                if (newState === 0) filterMap.delete(label);
                else filterMap.set(label, newState);
                renderFilters();
                renderCourses();
            });
            pill.addEventListener('keydown', (e) => {
                if (e.key === ' ' || e.key === 'Enter') {
                    pill.click();
                    e.preventDefault();
                }
            });
            container.appendChild(pill);
        }

        assessmentTypeFilters.innerHTML = '';
        Array.from(allAssessmentTypes).sort().forEach(t => createPill(t, assessmentTypeFilterState, assessmentTypeFilters));
        workTypeFilters.innerHTML = '';
        Array.from(allWorkTypes).sort().forEach(w => createPill(w, workTypeFilterState, workTypeFilters));
    }

    function renderCourses() {
        console.log('renderCourses called with courses:', courses); // Debug log
        const container = document.getElementById('courseContainer');
        const searchVal = document.getElementById('searchInput').value.toLowerCase();
        container.innerHTML = '';

        // Returns true if the value is included, false if excluded, or null if neutral
        function getFilterState(val, map) {
            if (map.size === 0) return null;
            if (map.get(val) === 1) return true;
            if (map.get(val) === -1) return false;
            return null;
        }

        // Returns true if the assessment matches all include filters and none of the exclude filters
        function assessmentMatchesFilters(a) {
            // Assessment Type
            const typeState = getFilterState(a.type, assessmentTypeFilterState);
            if (typeState === false) return false;
            // Work Type
            const workState = getFilterState(a.groupwork, workTypeFilterState);
            if (workState === false) return false;

            // If there are any include filters, must match them
            if ([...assessmentTypeFilterState.values()].includes(1) && typeState !== true) return false;
            if ([...workTypeFilterState.values()].includes(1) && workState !== true) return false;

            return true;
        }

        // Exclude course if ANY assessment matches an exclude filter
        function courseIsExcluded(course) {
            // Assessment type excludes
            const typeExcludes = [...assessmentTypeFilterState.entries()].filter(([k, v]) => v === -1).map(([k]) => k);
            if (typeExcludes.length > 0 && course.assessments.some(a => typeExcludes.includes(a.type))) return true;
            // Work type excludes
            const workExcludes = [...workTypeFilterState.entries()].filter(([k, v]) => v === -1).map(([k]) => k);
            if (workExcludes.length > 0 && course.assessments.some(a => workExcludes.includes(a.groupwork))) return true;
            return false;
        }

        // Only show courses where at least one assessment matches all include filters and none match any exclude filter
        const filteredCourses = courses.filter(course => {
            if (searchVal && !(course.name.toLowerCase().includes(searchVal) || course.code.includes(searchVal))) {
                return false;
            }
            if (courseIsExcluded(course)) return false;

            // If there are any include filters, require at least one assessment matches all includes
            const hasIncludeType = [...assessmentTypeFilterState.values()].includes(1);
            const hasIncludeWork = [...workTypeFilterState.values()].includes(1);
            if (hasIncludeType || hasIncludeWork) {
                return course.assessments.some(a => assessmentMatchesFilters(a));
            }
            // If no includes, just require not excluded
            return true;
        });

        console.log('Filtered courses:', filteredCourses); // Debug log

        if (filteredCourses.length === 0) {
            console.log('No courses to display'); // Debug log
            const empty = document.createElement('div');
            empty.className = 'empty-state';
            empty.textContent = 'No courses match the filters.';
            container.appendChild(empty);
            return;
        }

        filteredCourses.forEach(course => {
            // Determine main work type for background
            const mainWork = getMainWorkType(course);
            const card = document.createElement('div');
            card.className = 'course-card';
            card.setAttribute('data-work', mainWork);

            const header = document.createElement('div');
            header.className = 'card-header';
            header.innerHTML = `<h2>${course.code}</h2><p>${course.name}</p>`;

            const body = document.createElement('div');
            body.className = 'card-body';
            
            // Add prerequisites section
            const prereqs = document.createElement('div');
            prereqs.className = 'prerequisites';
            prereqs.innerHTML = `
                <p><strong>Prerequisites:</strong> ${course.prerequisites}</p>
            `;
            body.appendChild(prereqs);
            
            // Add a divider
            const divider = document.createElement('hr');
            divider.style.borderTop = '1px solid #eee';
            divider.style.margin = '10px 0';
            body.appendChild(divider);
            
            // Assessments section
            const assessmentsTitle = document.createElement('h3');
            assessmentsTitle.textContent = 'Assessments';
            assessmentsTitle.style.margin = '0 0 10px 0';
            assessmentsTitle.style.fontSize = '16px';
            body.appendChild(assessmentsTitle);
            
            course.assessments.forEach(a => {
                const item = document.createElement('div');
                item.className = 'assessment-item';
                
                // Determine groupwork tag color class
                let groupworkClass = 'tag-individual';
                if (a.groupwork.toLowerCase().includes('group')) {
                    groupworkClass = 'tag-group';
                }
                
                // Neon tag for assessment type
                const typeTagClass = getTypeTagClass(a.type);

                // Add length next to the intent/description, styled as a subtle pill below or beside
                item.innerHTML = `
                    <div class="assessment-header">
                        <span class="assessment-title">${a.name}</span>
                        <span class="assessment-weight">${a.weight}%</span>
                    </div>
                    <div class="assessment-intent">
                        <span>${a.intent}</span>
                        ${a.length && a.length !== 'Not specified' ? `<span class="length-pill subtle">${a.length}</span>` : ''}
                    </div>
                    <div class="assessment-details">
                        <span class="tag ${typeTagClass}">${a.type}</span>
                        <span class="tag ${groupworkClass}">${a.groupwork}</span>
                    </div>
                `;
                body.appendChild(item);
            });

            card.appendChild(header);
            card.appendChild(body);
            container.appendChild(card);
        });
    }

    document.getElementById('clearFilters').addEventListener('click', () => {
        assessmentTypeFilterState.clear();
        workTypeFilterState.clear();
        document.getElementById('searchInput').value = '';
        renderFilters();
        renderCourses();
    });

    document.getElementById('searchInput').addEventListener('input', () => renderCourses());

    // Theme toggle
    const themeBtn = document.getElementById('themeToggle');
    function setTheme(dark) {
        document.body.classList.toggle('dark-theme', dark);
        themeBtn.textContent = dark ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
        localStorage.setItem('theme', dark ? 'dark' : 'light');
    }
    themeBtn.addEventListener('click', () => {
        setTheme(!document.body.classList.contains('dark-theme'));
    });
    // On load, set theme from localStorage
    setTheme(localStorage.getItem('theme') === 'dark');

    // Helper: get main assessment type for subject
    function getMainAssessmentType(course) {
        if (!course.assessments || course.assessments.length === 0) return '';
        // Priority: Project > Laboratory/practical > Presentation > Quiz/test > Examination > Other
        const typeOrder = [
            "Project", "Laboratory/practical", "Presentation", "Quiz/test", "Examination"
        ];
        let found = '';
        for (const t of typeOrder) {
            if (course.assessments.some(a => (a.type||'').toLowerCase().includes(t.toLowerCase()))) {
                found = t;
                break;
            }
        }
        if (!found) {
            found = (course.assessments[0].type || 'Other');
        }
        return found;
    }
    // Helper: get tag class for assessment type
    function getTypeTagClass(type) {
        const t = (type||'').toLowerCase();
        if (t.includes('project')) return 'tag-type tag-project';
        if (t.includes('lab')) return 'tag-type tag-individual';
        if (t.includes('presentation')) return 'tag-type tag-presentation';
        if (t.includes('quiz') || t.includes('test')) return 'tag-type tag-type';
        if (t.includes('exam')) return 'tag-type tag-exam';
        return 'tag-type tag-other';
    }
    // Helper: get main work type for subject
    function getMainWorkType(course) {
        if (!course.assessments || course.assessments.length === 0) return '';
        // Priority: Group > Presentation > Examination > Individual > Other
        const workOrder = [
            "Group", "Presentation", "Examination", "Individual"
        ];
        let found = '';
        for (const t of workOrder) {
            if (course.assessments.some(a => (a.groupwork||'').toLowerCase().includes(t.toLowerCase()))) {
                found = t;
                break;
            }
        }
        if (!found) {
            found = (course.assessments[0].groupwork || 'Other');
        }
        return found;
    }

    function showCourseDetail(course) {
        const modal = document.getElementById('courseDetailModal');
        const content = document.getElementById('modalContent');
        
        let html = `
            <div class="modal-header">
                <h2>${course.code} - ${course.title}</h2>
                <p>${course.credit_points}</p>
            </div>
        `;

        // Overview section
        if (course.overview) {
            html += `
                <div class="detail-section">
                    <h3>Overview</h3>
                    <p>${course.overview}</p>
                </div>
            `;
        }

        // Prerequisites
        if (course.requisites) {
            html += `
                <div class="detail-section">
                    <h3>Prerequisites</h3>
                    <p>${course.requisites}</p>
                </div>
            `;
        }

        // Learning Outcomes
        if (course.learning_outcomes && course.learning_outcomes.length > 0) {
            html += `
                <div class="detail-section">
                    <h3>Learning Outcomes</h3>
                    <ul class="detail-list">
                        ${course.learning_outcomes.map(lo => 
                            `<li>${lo.no}. ${lo.text}</li>`
                        ).join('')}
                    </ul>
                </div>
            `;
        }

        // Assessment Details
        if (course.assessment && course.assessment.length > 0) {
            html += `
                <div class="detail-section">
                    <h3>Assessment Tasks</h3>
                    <div class="detail-grid">
                        ${course.assessment.map(task => `
                            <div class="assessment-detail">
                                <h4>${task.title}</h4>
                                <ul class="detail-list">
                                    ${Object.entries(task.details).map(([key, value]) => 
                                        `<li><strong>${key}:</strong> ${value}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        content.innerHTML = html;
        modal.style.display = 'block';
    }

    function closeModal() {
        const modal = document.getElementById('courseDetailModal');
        modal.style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('courseDetailModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    function renderCourses(coursesToRender) {
        const container = document.getElementById('cardContainer');
        
        if (!coursesToRender || coursesToRender.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>No courses found</h3>
                    <p>Try adjusting your filters or importing some courses</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = coursesToRender.map(course => {
            let totalWeight = 0;
            const assessments = course.assessment.map(task => {
                const weight = parseInt(task.details.Weight) || 0;
                totalWeight += weight;
                return `
                    <div class="assessment-item" onclick="showCourseDetail(${JSON.stringify(course)})">
                        <div class="assessment-header">
                            <span class="assessment-title">${task.title}</span>
                            <span class="assessment-weight">${task.details.Weight || '0%'}</span>
                        </div>
                        <div class="assessment-intent">${task.details.Intent || 'No description available'}</div>
                        <div class="assessment-details">
                            <span class="tag tag-type">${task.details['Objective(s)'] ? 'Objectives' : 'No objectives'}</span>
                            <span class="tag ${task.details.Groupwork?.toLowerCase().includes('group') ? 'tag-group' : 'tag-individual'}">
                                ${task.details.Groupwork || 'Individual'}
                            </span>
                            <span class="length-pill">${task.details.Length || 'Duration not specified'}</span>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="course-card" data-code="${course.code}">
                    <div class="card-header" onclick="showCourseDetail(${JSON.stringify(course)})">
                        <h2>${course.code} - ${course.title}</h2>
                        <p>${course.credit_points} - ${totalWeight}% Total Weight</p>
                    </div>
                    <div class="card-body">
                        <div class="prerequisites">
                            <strong>Prerequisites:</strong> ${course.requisites || 'None'}
                        </div>
                        ${assessments}
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateLoadingProgress(completed, total, code) {
        const progressBar = document.querySelector('.loading-spinner .progress-bar');
        const statusText = document.getElementById('loadingStatus');
        
        if (progressBar && statusText) {
            const percentage = (completed / total) * 100;
            progressBar.style.width = `${percentage}%`;
            statusText.textContent = `Loading ${code}... (${completed}/${total})`;
        }
    }
    </script>
</body>
</html>
