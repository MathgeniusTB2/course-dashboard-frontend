<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Assessment Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #f5f7fa;
            --card-bg: #fff;
            --text: #333;
            --accent: #3498db;
            --accent-dark: #2980b9;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --danger-dark: #c0392b;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --card-shadow: 0 8px 30px rgba(0,0,0,0.12);
            --header-bg: #3498db;
            --header-text: #fff;
            --tag-type-bg: #e3f2fd;
            --tag-type-text: #1976d2;
            --tag-individual-bg: #e8f5e9;
            --tag-individual-text: #388e3c;
            --tag-group-bg: #fff3e0;
            --tag-group-text: #e65100;
            --prereq-bg: #f8f9fa;
            --neon-blue: #00eaff;
            --neon-green: #39ff14;
            --neon-pink: #ff4fff;
            --neon-orange: #ffb86c;
            --neon-yellow: #ffe347;
            --neon-purple: #a259ff;
            --neon-red: #ff4f4f;
            --transition-speed: 0.3s;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
                         Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text);
            background-color: var(--bg);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .dark-theme {
            --bg: #15181e;
            --card-bg: #23262e;
            --text: #e3e8f0;
            --accent: #5ecbfa;
            --accent-dark: #1976d2;
            --secondary: #43e97b;
            --danger: #ff5c5c;
            --danger-dark: #c0392b;
            --shadow: 0 4px 20px rgba(0,0,0,0.5);
            --card-shadow: 0 8px 30px rgba(0,0,0,0.6);
            --header-bg: #23262e;
            --header-text: #e3e8f0;
            --tag-type-bg: #22304a;
            --tag-type-text: #5ecbfa;
            --tag-individual-bg: #1e2e22;
            --tag-individual-text: #39ff14;
            --tag-group-bg: #3a232e;
            --tag-group-text: #ffb4d4;
            --prereq-bg: #23262e;
        }
        
        header {
            text-align: center;
            padding: 20px 0 40px;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2.4rem;
            margin-bottom: 10px;
            font-weight: 800;
            letter-spacing: -0.5px;
            transition: color var(--transition-speed);
        }
        
        .dark-theme h1 {
            color: #e3e8f0;
            text-shadow: 0 2px 8px rgba(17, 17, 17, 0.5);
        }
        
        .app-description {
            max-width: 600px;
            margin: 0 auto 20px;
            color: #64748b;
            font-size: 1rem;
            line-height: 1.6;
        }
        
        .dark-theme .app-description {
            color: #94a3b8;
        }
        
        #fetchBtn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--secondary);
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 14px rgba(46, 204, 113, 0.4);
            border: none;
            margin: 0 auto;
        }
        
        #fetchBtn:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.5);
        }
        
        #fetchBtn:active {
            transform: translateY(0);
        }
        
        #fetchBtn i {
            margin-right: 8px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .filter-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: background var(--transition-speed), box-shadow var(--transition-speed);
        }
        
        .filter-section h3 {
            margin-top: 0;
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            transition: color var(--transition-speed);
        }
        
        .filter-section h3 i {
            margin-right: 8px;
            opacity: 0.8;
        }
        
        .search-input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            font-size: 15px;
            transition: border var(--transition-speed), background var(--transition-speed), color var(--transition-speed);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .dark-theme .search-input {
            background: #181c22;
            color: #e3e8f0;
            border: 1px solid #333a47;
        }
        
        .filter-pill {
            display: inline-flex;
            align-items: center;
            border-radius: 20px;
            padding: 6px 16px;
            margin: 4px 8px 4px 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: 2px solid transparent;
            background: #f0f8ff;
            color: var(--accent);
            transition: all 0.2s;
            user-select: none;
        }
        
        .filter-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .filter-pill.included {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        
        .filter-pill.excluded {
            background: var(--danger);
            color: #fff;
            border-color: var(--danger);
        }
        
        .filter-pill .pill-x {
            margin-left: 8px;
            font-weight: bold;
            font-size: 15px;
            pointer-events: none;
        }
        
        .dark-theme .filter-pill {
            background: #1e293b;
            color: #4fc3f7;
        }
        
        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            background-color: var(--accent-dark);
            transform: translateY(-2px);
        }
        
        button i {
            margin-right: 6px;
        }
        
        .clear-filters {
            background-color: var(--danger);
            margin-top: 15px;
            width: 100%;
        }
        
        .clear-filters:hover {
            background-color: var(--danger-dark);
        }
        
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }
        
        .course-card {
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.4s;
            border: 2px solid transparent;
            position: relative;
        }
        
        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 16px 40px rgba(0,0,0,0.15);
        }
        
        .dark-theme .course-card:hover {
            box-shadow: 0 16px 40px rgba(0,0,0,0.6);
        }
        
        .card-header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        .card-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
        }
        
        .card-header p {
            margin: 6px 0 0;
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .prerequisites {
            background-color: var(--prereq-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            border-left: 4px solid var(--accent);
            transition: background-color var(--transition-speed);
        }
        
        .prerequisites strong {
            color: var(--accent);
            font-weight: 600;
        }
        
        .assessment-item {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
            transition: border-color var(--transition-speed);
        }
        
        .dark-theme .assessment-item {
            border-bottom: 1px solid #232b3a;
        }
        
        .assessment-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .assessment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .assessment-title {
            font-weight: 600;
            color: #2c3e50;
            transition: color var(--transition-speed);
        }
        
        .dark-theme .assessment-title {
            color: #e3e8f0;
        }
        
        .assessment-weight {
            background: #f1c40f;
            color: #7f5200;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        
        .assessment-intent {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #6b7280;
            margin: 6px 0;
            font-style: italic;
            flex-wrap: wrap;
            transition: color var(--transition-speed);
        }
        
        .dark-theme .assessment-intent {
            color: #94a3b8;
        }
        
        .assessment-details {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        .tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .tag-type {
            background: var(--tag-type-bg);
            color: var(--tag-type-text);
        }
        
        .tag-individual {
            background: var(--tag-individual-bg);
            color: var(--tag-individual-text);
        }
        
        .tag-group {
            background: var(--tag-group-bg);
            color: var(--tag-group-text);
        }
        
        .dark-theme .tag-type {
            background: transparent;
            color: var(--neon-blue);
            text-shadow: 0 0 6px var(--neon-blue), 0 0 2px #fff;
            box-shadow: 0 0 8px 2px var(--neon-blue);
            border: 1.5px solid var(--neon-blue);
        }
        
        .dark-theme .tag-individual {
            background: transparent;
            color: var(--neon-green);
            text-shadow: 0 0 6px var(--neon-green), 0 0 2px #fff;
            box-shadow: 0 0 8px 2px var(--neon-green);
            border: 1.5px solid var(--neon-green);
        }
        
        .dark-theme .tag-group {
            background: transparent;
            color: var(--neon-orange);
            text-shadow: 0 0 6px var(--neon-orange), 0 0 2px #fff;
            box-shadow: 0 0 8px 2px var(--neon-orange);
            border: 1.5px solid var(--neon-orange);
        }
        
        .length-pill {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            background: #e9ecef;
            color: #6c757d;
            font-size: 11px;
            font-weight: 500;
            vertical-align: baseline;
            opacity: 0.85;
            transition: all 0.2s;
        }
        
        .dark-theme .length-pill {
            background: #23262e;
            color: #b0b8c1;
            border: none;
            box-shadow: none;
            opacity: 0.7;
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 0;
            color: #7f8c8d;
            grid-column: 1 / -1;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #cbd5e1;
        }
        
        .empty-state h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: #64748b;
        }
        
        .empty-state p {
            max-width: 400px;
            margin: 0 auto;
            color: #94a3b8;
        }
        
        .dark-theme .empty-state i {
            color: #334155;
        }
        
        .dark-theme .empty-state h3 {
            color: #cbd5e1;
        }
        
        .dark-theme .empty-state p {
            color: #94a3b8;
        }
        
        /* Course card backgrounds and themes */
        /* Light mode */
        .course-card[data-work="Individual"] {
            background: linear-gradient(135deg, #e8f5e9 80%, #fff 100%);
            border-color: rgba(57, 255, 20, 0.2);
        }
        
        .course-card[data-work^="Group"] {
            background: linear-gradient(135deg, #fff3e0 80%, #fff 100%);
            border-color: rgba(255, 184, 108, 0.2);
        }
        
        .course-card[data-work="Presentation"] {
            background: linear-gradient(135deg, #f3e0ff 80%, #fff 100%);
            border-color: rgba(162, 89, 255, 0.2);
        }
        
        .course-card[data-work="Examination"] {
            background: linear-gradient(135deg, #fffde7 80%, #fff 100%);
            border-color: rgba(255, 227, 71, 0.2);
        }

        /* Dark mode */
        .dark-theme .course-card[data-work="Individual"] {
            background: linear-gradient(135deg, #1e2e22 80%, #23262e 100%);
            border-color: var(--neon-green);
            box-shadow: 0 0 16px 0 rgba(57, 255, 20, 0.3), var(--shadow);
        }
        
        .dark-theme .course-card[data-work^="Group"] {
            background: linear-gradient(135deg, #2d2320 80%, #23262e 100%);
            border-color: var(--neon-orange);
            box-shadow: 0 0 16px 0 rgba(255, 184, 108, 0.3), var(--shadow);
        }
        
        .dark-theme .course-card[data-work="Presentation"] {
            background: linear-gradient(135deg, #2a1a38 80%, #23262e 100%);
            border-color: var(--neon-purple);
            box-shadow: 0 0 16px 0 rgba(162, 89, 255, 0.3), var(--shadow);
        }
        
        .dark-theme .course-card[data-work="Examination"] {
            background: linear-gradient(135deg, #2a2a1a 80%, #23262e 100%);
            border-color: var(--neon-yellow);
            box-shadow: 0 0 16px 0 rgba(255, 227, 71, 0.3), var(--shadow);
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 40px 0;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(52, 152, 219, 0.2);
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        .loading-progress {
            margin-top: 20px;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .loading-spinner #loadingStatus {
            color: var(--text);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .loading-spinner .progress-container {
            width: 100%;
            height: 6px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
        }

        .dark-theme .loading-spinner .progress-container {
            background: #2a2d35;
        }

        .loading-spinner .progress-bar {
            height: 100%;
            width: 0;
            background: var(--accent);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loading-errors {
            margin: 10px 0;
            color: var(--danger);
            font-size: 14px;
        }
        
        .loading-errors .error-item {
            background: rgba(231, 76, 60, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 4px 0;
        }
        
        .dark-theme .loading-errors .error-item {
            background: rgba(255, 92, 92, 0.1);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Theme toggle button */
        #themeToggle {
            position: relative;
            width: 100%;
            cursor: pointer;
            overflow: hidden;
        }
        
        #themeToggle i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        /* Media queries for better responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .card-container {
                grid-template-columns: 1fr;
            }
            
            .filter-pill {
                padding: 5px 12px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }
            
            #fetchBtn {
                width: 100%;
            }
            
            .filter-section {
                padding: 15px;
            }
        }

        .import-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            max-width: 500px;
            width: 90%;
            z-index: 1000;
        }
        .import-dialog textarea {
            width: 100%;
            min-height: 150px;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: monospace;
            resize: vertical;
        }
        .dark-theme .import-dialog textarea {
            background: #181c22;
            color: #e3e8f0;
            border-color: #333a47;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
            z-index: 999;
        }
        .progress-container {
            width: 300px;
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin: 0 auto;
            overflow: hidden;
        }
        .dark-theme .progress-container {
            background: #2a2d35;
        }
        .progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
        }
        .import-help {
            font-size: 13px;
            color: #666;
            margin: 10px 0;
            line-height: 1.4;
        }
        .dark-theme .import-help {
            color: #b0b8c1;
        }
        .loading-status {
            font-size: 14px;
            color: #64748b;
            margin: 15px 0;
            font-weight: 500;
        }
        .dark-theme .loading-status {
            color: #94a3b8;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--card-bg);
            margin: 40px auto;
            padding: 30px;
            border-radius: 16px;
            max-width: 900px;
            width: 90%;
            position: relative;
            box-shadow: var(--card-shadow);
            transition: background var(--transition-speed);
        }

        .modal-header {
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 15px;
        }

        .dark-theme .modal-header {
            border-bottom-color: rgba(255,255,255,0.1);
        }

        .modal-close {
            position: absolute;
            right: 20px;
            top: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text);
            padding: 5px;
            transition: color var(--transition-speed);
        }

        .modal-close:hover {
            color: var(--danger);
            transform: none;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .detail-list {
            list-style: none;
            padding: 0;
        }

        .detail-list li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .loading-placeholder {
            text-align: center;
            color: var(--text);
            opacity: 0.6;
            font-style: italic;
        }

        .overview-section {
            background: var(--prereq-bg);
            padding: 30px;
            border-radius: 16px;
            margin: 0 0 25px;
            position: relative;
            box-shadow: 0 2px 12px rgba(0,0,0,0.05);
            border-left: 4px solid var(--accent);
            transition: all var(--transition-speed);
        }

        .overview-content {
            font-size: 1.05rem;
            line-height: 1.8;
            color: var(--text);
            max-width: 80ch;
            margin: 0 auto;
        }

        .dark-theme .overview-content {
            color: #e3e8f0;
        }

        .overview-paragraph {
            margin-bottom: 1.5em;
            text-align: left;
            letter-spacing: 0.01em;
            word-spacing: 0.05em;
        }

        .overview-paragraph:last-child {
            margin-bottom: 0;
        }

        .dark-theme .overview-section {
            background: rgba(255, 255, 255, 0.03);
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
        }

        .overview-preview {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text);
            margin-bottom: 20px;
            padding: 20px;
            background: var(--prereq-bg);
            border-radius: 12px;
            border-left: 4px solid var(--accent);
            transition: all var(--transition-speed);
        }

        .overview-preview p {
            margin: 0.8em 0;
        }

        .overview-preview p:first-child {
            margin-top: 0;
        }

        .overview-preview p:last-child {
            margin-bottom: 0;
        }

        .dark-theme .overview-preview {
            background: rgba(255, 255, 255, 0.03);
            color: #94a3b8;
        }

        .overview-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--accent);
        }

        .overview-section h3 i {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .overview-section-category {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .overview-section-category:last-child {
            margin-bottom: 0;
        }

        .overview-section-category h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent);
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .overview-section-category h4 i {
            opacity: 0.9;
        }

        .overview-content-category {
            color: var(--text);
            line-height: 1.7;
        }

        .topics-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }

        .topics-list li {
            position: relative;
            padding-left: 20px;
            line-height: 1.5;
        }

        .topics-list li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--accent);
        }

        .dark-theme .overview-section-category {
            background: rgba(255, 255, 255, 0.03);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .dark-theme .overview-content-category {
            color: #e3e8f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Course Assessment Dashboard</h1>
            <p class="app-description">Analyze and track assessment details across your university courses. Filter by assessment types, work requirements, and search for specific courses.</p>
            <button id="fetchBtn"><i class="fas fa-download"></i> Import Courses</button>
        </header>
        
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <div class="loading-progress">
                <p id="loadingStatus">Loading your courses...</p>
                <div id="loadingErrors" class="loading-errors"></div>
                <div class="progress-container">
                    <div class="progress-bar" id="loadingProgress"></div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="filter-section">
                <h3><i class="fas fa-clipboard-list"></i> Assessment Types</h3>
                <div class="checkbox-container" id="assessmentTypeFilters"></div>
            </div>
            
            <div class="filter-section">
                <h3><i class="fas fa-users"></i> Work Types</h3>
                <div class="checkbox-container" id="workTypeFilters"></div>
            </div>
            
            <div class="filter-section">
                <h3><i class="fas fa-search"></i> Search</h3>
                <input type="text" id="searchInput" class="search-input" placeholder="Search by course name or code...">
                <button class="clear-filters" id="clearFilters"><i class="fas fa-times"></i> Clear Filters</button>
            </div>
            
            <div class="filter-section">
                <h3><i class="fas fa-palette"></i> Theme</h3>
                <button id="themeToggle"><i class="fas fa-moon"></i> Dark Mode</button>
            </div>
        </div>
        
        <div class="card-container" id="cardContainer">
            <!-- Cards will be populated here -->
        </div>
    </div>
    <div id="importDialog" class="import-dialog" style="display:none;">
        <h3>Import Courses</h3>
        <div class="import-help">
            <p>Paste your course list below. The system will automatically extract course codes (5-digit numbers) from any text format, including:</p>
            <ul>
                <li>Handbook pages</li>
                <li>Course lists</li>
                <li>Study planners</li>
                <li>Plain text with course codes</li>
            </ul>
        </div>
        <textarea id="importText" placeholder="Example:
Autumn session
33130 Mathematics 1     6cp
41039 Programming 1     6cp
..."></textarea>
        <div class="progress-container" style="display:none;">
            <div class="progress-bar"></div>
        </div>
        <button onclick="processImport()">Import</button>
        <button onclick="closeImport()" style="background:#666">Cancel</button>
    </div>
    <div id="importOverlay" class="overlay" style="display:none;"></div>

    <!-- Course Detail Modal -->
    <div id="courseDetailModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalContent">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
    // Global state
    let courses = [];
    const BACKEND_URL = "https://course-dashboard-backend.onrender.com";  // Changed from remote URL to localhost
    const WARMUP_TIMEOUT = 60000; // 60 seconds timeout for cold starts
    let isWarmedUp = false;

    // Theme handling - single implementation
    const themeToggle = document.getElementById('themeToggle');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    
    function setTheme(isDark) {
        document.body.classList.toggle('dark-theme', isDark);
        if (themeToggle) {
            themeToggle.innerHTML = isDark ? 
                '<i class="fas fa-sun"></i> Light Mode' : 
                '<i class="fas fa-moon"></i> Dark Mode';
        }
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    // Initialize theme
    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            setTheme(savedTheme === 'dark');
        } else {
            setTheme(prefersDark.matches);
        }
    }

    // Theme toggle event listener
    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            setTheme(!document.body.classList.contains('dark-theme'));
        });
    }

    // Listen for system theme changes
    prefersDark.addListener((e) => {
        if (!localStorage.getItem('theme')) {
            setTheme(e.matches);
        }
    });

    // Initialize theme on page load
    document.addEventListener('DOMContentLoaded', initTheme);

    // Modal functionality - single implementation
    function showCourseDetail(course) {
        const modal = document.getElementById('courseDetailModal');
        const content = document.getElementById('modalContent');
        
        if (!modal || !content) {
            console.error('Modal elements not found');
            return;
        }

        try {
            let html = `
                <div class="modal-header">
                    <h2>${course.code} - ${course.title}</h2>
                    <p>${course.credit_points}</p>
                </div>
            `;

            if (course.overview) {
                html += `
                    <div class="detail-section overview-section">
                        <h3><i class="fas fa-info-circle"></i> Course Overview</h3>
                        <div class="overview-content">
                            ${formatOverviewText(course.overview)}
                        </div>
                    </div>
                `;
            }

            if (course.requisites) {
                html += `
                    <div class="detail-section">
                        <h3>Prerequisites</h3>
                        <p>${course.requisites}</p>
                    </div>
                `;
            }

            if (course.learning_outcomes?.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3>Learning Outcomes</h3>
                        <ul class="detail-list">
                            ${course.learning_outcomes.map(lo => 
                                `<li><strong>${lo.no}.</strong> ${lo.text}</li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }

            if (course.assessments?.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3>Assessment Tasks</h3>
                        <div class="detail-grid">
                            ${course.assessments.map(task => `
                                <div class="assessment-detail">
                                    <h4>${task.title}</h4>
                                    <ul class="detail-list">
                                        <li><strong>Type:</strong> ${task.type}</li>
                                        <li><strong>Weight:</strong> ${task.weight}%</li>
                                        <li><strong>Work Type:</strong> ${task.groupwork}</li>
                                        ${task.length ? `<li><strong>Length:</strong> ${task.length}</li>` : ''}
                                        ${task.intent ? `<li><strong>Description:</strong> ${task.intent}</li>` : ''}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
            modal.style.display = 'block';

            // Set up event listeners
            setupModalListeners(modal);
        } catch (error) {
            console.error('Error showing course details:', error);
        }
    }

    function setupModalListeners(modal) {
        const closeModalHandler = (e) => {
            if (e.target === modal) {
                closeModal();
            }
        };

        const escapeHandler = (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        };

        modal.addEventListener('click', closeModalHandler);
        document.addEventListener('keydown', escapeHandler);

        // Cleanup listeners when modal closes
        modal.addEventListener('hide', () => {
            modal.removeEventListener('click', closeModalHandler);
            document.removeEventListener('keydown', escapeHandler);
        });
    }

    function closeModal() {
        const modal = document.getElementById('courseDetailModal');
        if (modal) {
            modal.style.display = 'none';
            modal.dispatchEvent(new Event('hide'));
        }
    }

    // Filter state
    const assessmentTypeFilterState = new Map();
    const workTypeFilterState = new Map();

    async function fetchAndInit(codes) {
        const spinner = document.getElementById('loadingSpinner');
        const status = document.getElementById('loadingStatus');
        const progress = document.getElementById('loadingProgress');
        const errorsDiv = document.getElementById('loadingErrors');
        
        if (!spinner || !status || !progress || !errorsDiv) {
            console.error('Required UI elements not found');
            return;
        }
        
        spinner.style.display = 'block';
        progress.style.width = '0%';
        errorsDiv.innerHTML = '';
        
        // Ensure backend is warmed up
        if (!isWarmedUp) {
            const warmedUp = await warmupBackend();
            if (!warmedUp) return;
        }

        try {
            const response = await fetch(`${BACKEND_URL}/api/courses`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ subject_codes: codes })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let completed = 0;
            let total = codes.length;

            while (true) {
                const {value, done} = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, {stream: true});
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line in buffer
                
                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const data = JSON.parse(line);
                        
                        if (data.type === 'progress') {
                            completed = data.completed;
                            total = data.total;
                            const percentage = Math.round((completed / total) * 100);
                            progress.style.width = `${percentage}%`;
                            status.textContent = `Processing ${data.code}... (${completed}/${total})`;
                            
                            if (data.error) {
                                errorsDiv.innerHTML += `<div class="error-item">${data.code}: ${data.error}</div>`;
                            }
                        }
                        else if (data.type === 'complete') {
                            // Transform the data structure to match frontend expectations
                            courses = data.results.filter(c => !c.error).map(c => ({
                                code: c.code,
                                title: c.title,
                                credit_points: c.credit_points,
                                requisites: c.requisites,
                                overview: c.overview,
                                learning_outcomes: c.learning_outcomes,
                                assessments: (c.assessment || []).map(a => ({
                                    title: a.title,
                                    type: getAssessmentType(a),
                                    groupwork: determineGroupwork(a.details.Groupwork),
                                    weight: parseInt((a.details.Weight || '0').replace(/%/g, ''), 10) || 0,
                                    length: a.details.Length || 'Not specified',
                                    intent: a.details.Intent || '',
                                    details: a.details || {}
                                }))
                            }));

                            if (courses.length > 0) {
                                initializeDashboard();
                            }
                        }
                    } catch (e) {
                        console.error('Error processing message:', e, 'Line:', line);
                    }
                }
            }
        } catch (e) {
            console.error('Fetch error:', e);
            status.textContent = 'Failed to fetch courses';
            errorsDiv.innerHTML = `<div class="error-item">Error: ${e.message}</div>`;
        } finally {
            setTimeout(() => {
                spinner.style.display = 'none';
            }, 500);
        }
    }

    // Helper function to determine assessment type
    function getAssessmentType(assessment) {
        const title = (assessment.title || '').toLowerCase();
        const details = assessment.details || {};
        
        if (title.includes('exam') || details.Type?.toLowerCase().includes('exam')) {
            return 'Examination';
        } else if (title.includes('test') || details.Type?.toLowerCase().includes('test')) {
            return 'Test';
        } else if (title.includes('quiz') || details.Type?.toLowerCase().includes('quiz')) {
            return 'Quiz';
        } else if (title.includes('presentation') || details.Type?.toLowerCase().includes('presentation')) {
            return 'Presentation';
        } else if (title.includes('project') || details.Type?.toLowerCase().includes('project')) {
            return 'Project';
        } else if (title.includes('assignment') || details.Type?.toLowerCase().includes('assignment')) {
            return 'Assignment';
        }
        
        return 'Other';
    }

    // Helper function to determine groupwork status
    function determineGroupwork(groupworkText) {
        if (!groupworkText) return 'Individual';
        
        groupworkText = groupworkText.toLowerCase();
        if (groupworkText.includes('individual') || groupworkText === 'no') {
            return 'Individual';
        } else if (groupworkText.includes('group') || 
                groupworkText.includes('team') || 
                groupworkText.includes('pair')) {
            return 'Group';
        }
        
        // Try to get group size if specified
        const sizeMatch = groupworkText.match(/\d+/);
        if (sizeMatch) {
            return `Group (${sizeMatch[0]})`;
        }
        
        return groupworkText;
    }

    document.getElementById('fetchBtn').addEventListener('click', () => {
        document.getElementById('importDialog').style.display = '';
        document.getElementById('importOverlay').style.display = '';
    });

    function closeImport() {
        document.getElementById('importDialog').style.display = 'none';
        document.getElementById('importOverlay').style.display = 'none';
        document.getElementById('importText').value = '';
    }

    async function processImport() {
        const input = document.getElementById('importText').value;
        if (!input) return;

        // Extract all 5-digit numbers from any text
        const codes = [...new Set(input.match(/\b\d{5}\b/g))];
        
        if (codes.length === 0) {
            alert('No valid course codes found. Course codes are 5-digit numbers.');
            return;
        }

        closeImport();
        
        const progressContainer = document.querySelector('.progress-container');
        const progressBar = document.querySelector('.progress-bar');
        progressContainer.style.display = '';
        
        let progress = 0;
        const updateProgress = () => {
            progress += (100 - progress) * 0.1;
            progressBar.style.width = `${progress}%`;
        };
        
        const progressInterval = setInterval(updateProgress, 100);
        
        try {
            await fetchAndInit(codes);
        } finally {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            setTimeout(() => {
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
            }, 500);
        }
    }

    function initializeDashboard() {
        const assessmentTypeFilters = document.getElementById('assessmentTypeFilters');
        const workTypeFilters = document.getElementById('workTypeFilters');
        const cardContainer = document.getElementById('cardContainer');
        
        if (!assessmentTypeFilters || !workTypeFilters || !cardContainer) {
            console.error('Required dashboard elements not found. Check that all element IDs exist in HTML.');
            return;
        }

        if (!courses || !Array.isArray(courses)) {
            console.error('No course data available');
            return;
        }

        renderFilters();
        renderCourses();
    }

    function renderFilters() {
        const assessmentTypeFilters = document.getElementById('assessmentTypeFilters');
        const workTypeFilters = document.getElementById('workTypeFilters');
        
        if (!assessmentTypeFilters || !workTypeFilters || !courses) {
            console.error('Required elements not found or courses not loaded');
            return;
        }

        const allAssessmentTypes = new Set();
        const allWorkTypes = new Set();

        courses.forEach(course => {
            if (course.assessments) {
                course.assessments.forEach(a => {
                    if (a.type) allAssessmentTypes.add(a.type);
                    if (a.groupwork) allWorkTypes.add(a.groupwork);
                });
            }
        });

        assessmentTypeFilters.innerHTML = '';
        Array.from(allAssessmentTypes).sort().forEach(t => 
            createFilterPill(t, assessmentTypeFilterState, assessmentTypeFilters)
        );
        
        workTypeFilters.innerHTML = '';
        Array.from(allWorkTypes).sort().forEach(w => 
            createFilterPill(w, workTypeFilterState, workTypeFilters)
        );
    }

    // Helper function to format overview text with categories
    function formatOverviewText(text) {
        if (!text) return '';
        
        // Split into major sections based on content
        const parts = text.split(/(?=[A-Z][a-z]+ part:)|(?=Topics include:)/g)
            .map(p => p.trim())
            .filter(p => p);
            
        let html = '';
        
        // Format each section appropriately
        parts.forEach(part => {
            if (part.startsWith('Topics include:')) {
                html += `
                    <div class="overview-section-category">
                        <h4><i class="fas fa-list"></i> Key Topics</h4>
                        <div class="overview-content-category">
                            <ul class="topics-list">
                                ${part.replace('Topics include:', '')
                                    .split(';')
                                    .map(topic => `<li>${topic.trim()}</li>`)
                                    .join('')}
                            </ul>
                        </div>
                    </div>`;
            } else {
                // For the main description
                const paragraphs = part.split(/[.!?](?:\s+|\n)/)
                    .filter(p => p.trim())
                    .map(p => p.trim() + '.')
                    .reduce((acc, sentence, i, arr) => {
                        const paragraphIndex = Math.floor(i / 3);
                        if (!acc[paragraphIndex]) acc[paragraphIndex] = [];
                        acc[paragraphIndex].push(sentence);
                        return acc;
                    }, [])
                    .map(sentences => sentences.join(' '));

                html += `
                    <div class="overview-section-category">
                        <h4><i class="fas fa-book"></i> Course Description</h4>
                        <div class="overview-content-category">
                            ${paragraphs.map(p => `<p class="overview-paragraph">${p}</p>`).join('\n')}
                        </div>
                    </div>`;
            }
        });
        
        return html;
    }

    function renderCourses() {
        const container = document.getElementById('cardContainer');
        const searchVal = document.getElementById('searchInput')?.value.toLowerCase() || '';
        
        if (!courses || courses.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>No courses found</h3>
                    <p>Try importing some courses using the button above</p>
                </div>
            `;
            return;
        }

        // Apply all filters
        const filteredCourses = courses.filter(course => {
            if (!course) return false;
            
            // Text search filter
            if (searchVal && !(
                (course.title || '').toLowerCase().includes(searchVal) || 
                (course.code || '').includes(searchVal)
            )) {
                return false;
            }

            // Assessment type filter
            if (assessmentTypeFilterState.size > 0 && course.assessments) {
                const assessmentTypes = new Set(course.assessments.map(a => a.type));
                let includeBasedOnAssessment = false;
                let hasExcluded = false;

                for (const [type, state] of assessmentTypeFilterState) {
                    if (state === 1 && assessmentTypes.has(type)) {
                        includeBasedOnAssessment = true;
                    }
                    if (state === -1 && assessmentTypes.has(type)) {
                        hasExcluded = true;
                    }
                }

                // If there are include filters but none match, or if there are exclude filters and they match
                if ((Array.from(assessmentTypeFilterState.values()).includes(1) && !includeBasedOnAssessment) || 
                    hasExcluded) {
                    return false;
                }
            }

            // Work type filter
            if (workTypeFilterState.size > 0 && course.assessments) {
                const workTypes = new Set(course.assessments.map(a => a.groupwork));
                let includeBasedOnWork = false;
                let hasExcluded = false;

                for (const [type, state] of workTypeFilterState) {
                    if (state === 1 && workTypes.has(type)) {
                        includeBasedOnWork = true;
                    }
                    if (state === -1 && workTypes.has(type)) {
                        hasExcluded = true;
                    }
                }

                // If there are include filters but none match, or if there are exclude filters and they match
                if ((Array.from(workTypeFilterState.values()).includes(1) && !includeBasedOnWork) || 
                    hasExcluded) {
                    return false;
                }
            }

            return true;
        });

        if (filteredCourses.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <h3>No matching courses</h3>
                    <p>Try adjusting your search criteria</p>
                </div>
            `;
            return;
        }

        try {
            container.innerHTML = filteredCourses.map(course => {
                if (!course || !course.assessments) {
                    console.warn('Invalid course data:', course);
                    return '';
                }

                const assessmentHtml = course.assessments.map(task => {
                    if (!task) return '';
                    const groupworkTag = task.groupwork?.toLowerCase().includes('group') ? 
                        'tag-group' : 'tag-individual';
                    
                    return `
                        <div class="assessment-item">
                            <div class="assessment-header">
                                <span class="assessment-title">${task.title || 'Untitled Assessment'}</span>
                                <span class="assessment-weight">${task.weight || 0}%</span>
                            </div>
                            <div class="assessment-intent">${task.intent || 'No description available'}</div>
                            <div class="assessment-details">
                                <span class="tag tag-type">${task.type || 'Other'}</span>
                                <span class="tag ${groupworkTag}">${task.groupwork || 'Individual'}</span>
                                ${task.length ? `<span class="length-pill">${task.length}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                // Properly escape the course data
                const courseData = encodeURIComponent(JSON.stringify(course));

                return `
                    <div class="course-card" data-course="${courseData}">
                        <div class="card-header">
                            <h2>${course.code} - ${course.title}</h2>
                            <p>${course.credit_points}</p>
                        </div>
                        <div class="card-body">
                            ${course.overview ? `
                                <div class="overview-preview">
                                    ${truncateText(course.overview, 150)}
                                </div>
                            ` : ''}
                            <div class="prerequisites">
                                <strong>Prerequisites:</strong> ${course.requisites || 'None'}
                            </div>
                            ${assessmentHtml}
                        </div>
                    </div>
                `;
            }).join('');

            // Add click handlers after rendering
            document.querySelectorAll('.course-card').forEach(card => {
                card.addEventListener('click', function() {
                    const courseData = this.getAttribute('data-course');
                    if (courseData) {
                        try {
                            const course = JSON.parse(decodeURIComponent(courseData));
                            showCourseDetail(course);
                        } catch (err) {
                            console.error('Error parsing course data:', err);
                        }
                    }
                });
            });

            // Make the cards focusable and handle keyboard events
            document.querySelectorAll('.course-card').forEach(card => {
                card.setAttribute('tabindex', '0');
                card.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
        } catch (error) {
            console.error('Error rendering courses:', error);
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error rendering courses</h3>
                    <p>There was a problem displaying the courses. Please try refreshing the page.</p>
                </div>
            `;
        }
    }

    function formatOverview(text) {
        if (!text) return '';
        
        // Split into paragraphs and preserve meaningful line breaks
        return text.split(/\n{2,}/)  // Split on 2 or more newlines for paragraphs
            .map(p => p.trim())
            .filter(p => p)  // Remove empty paragraphs
            .map(p => `<p class="overview-paragraph">${p.replace(/\n/g, '<br>')}</p>`)
            .join('\n');
    }

    function showCourseDetail(course) {
        try {
            const modal = document.getElementById('courseDetailModal');
            const content = document.getElementById('modalContent');
            
            if (!modal || !content) {
                console.error('Modal elements not found');
                return;
            }

            let html = `
                <div class="modal-header">
                    <h2>${course.code} - ${course.title}</h2>
                    <p>${course.credit_points}</p>
                </div>
            `;

            // Overview section with improved formatting
            if (course.overview) {
                html += `
                    <div class="detail-section overview-section">
                        <h3><i class="fas fa-info-circle"></i> Course Overview</h3>
                        <div class="overview-content">
                            ${formatOverview(course.overview)}
                        </div>
                    </div>
                `;
            }

            // Add CSS for overview formatting
            const style = document.createElement('style');
            if (!document.querySelector('#overview-styles')) {
                style.id = 'overview-styles';
                style.textContent = `
                    .overview-section {
                        background: var(--prereq-bg);
                        border-radius: 8px;
                        padding: 20px;
                        margin-bottom: 30px;
                    }
                    
                    .overview-content {
                        font-size: 1rem;
                        line-height: 1.6;
                    }
                    
                    .overview-paragraph {
                        margin-bottom: 1em;
                    }
                    
                    .overview-paragraph:last-child {
                        margin-bottom: 0;
                    }
                    
                    .dark-theme .overview-section {
                        background: rgba(255, 255, 255, 0.05);
                    }
                `;
                document.head.appendChild(style);
            }

            // Rest of the sections
            if (course.requisites) {
                html += `
                    <div class="detail-section">
                        <h3>Prerequisites</h3>
                        <p>${course.requisites}</p>
                    </div>
                `;
            }

            // Learning Outcomes
            if (course.learning_outcomes && course.learning_outcomes.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3>Learning Outcomes</h3>
                        <ul class="detail-list">
                            ${course.learning_outcomes.map(lo => 
                                `<li>${lo.no}. ${lo.text}</li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }

            // Assessment Details
            if (course.assessments && course.assessments.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3>Assessment Tasks</h3>
                        <div class="detail-grid">
                            ${course.assessments.map(task => `
                                <div class="assessment-detail">
                                    <h4>${task.title}</h4>
                                    <ul class="detail-list">
                                        <li><strong>Type:</strong> ${task.type}</li>
                                        <li><strong>Weight:</strong> ${task.weight}%</li>
                                        <li><strong>Work Type:</strong> ${task.groupwork}</li>
                                        ${task.length ? `<li><strong>Length:</strong> ${task.length}</li>` : ''}
                                        ${task.intent ? `<li><strong>Description:</strong> ${task.intent}</li>` : ''}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
            modal.style.display = 'block';
            
            // Enable clicking outside modal to close
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            };
            
            // Enable escape key to close modal
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });
            
        } catch (error) {
            console.error('Error showing course details:', error);
        }
    }

    function closeModal() {
        const modal = document.getElementById('courseDetailModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('courseDetailModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    // Theme toggle
    const themeBtn = document.getElementById('themeToggle');
    function setTheme(dark) {
        document.body.classList.toggle('dark-theme', dark);
        themeBtn.textContent = dark ? '☀️ Light' : '🌙 Dark';
        localStorage.setItem('theme', dark ? 'dark' : 'light');
    }
    themeBtn.addEventListener('click', () => {
        setTheme(!document.body.classList.contains('dark-theme'));
    });
    // On load, set theme from localStorage
    setTheme(localStorage.getItem('theme') === 'dark');

    document.getElementById('clearFilters').addEventListener('click', () => {
        assessmentTypeFilterState.clear();
        workTypeFilterState.clear();
        document.getElementById('searchInput').value = '';
        renderFilters();
        renderCourses();
    });

    document.getElementById('searchInput').addEventListener('input', () => renderCourses());

    // Add warmup function
    async function warmupBackend() {
        const status = document.getElementById('loadingStatus');
        if (status) {
            status.textContent = 'Warming up the server...';
        }

        try {
            const startTime = Date.now();
            while (Date.now() - startTime < WARMUP_TIMEOUT) {
                const response = await fetch(`${BACKEND_URL}/api/warmup`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'ready') {
                        isWarmedUp = true;
                        return true;
                    }
                }
                // Wait a bit before retrying
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            throw new Error('Server warmup timed out');
        } catch (error) {
            console.error('Warmup error:', error);
            if (status) {
                status.textContent = 'Error warming up server. Please try again later.';
            }
            return false;
        }
    }

    // Enhance filter pills with better state management
    function createFilterPill(label, filterMap, container) {
        if (!label) return;
        
        const state = filterMap.get(label) || 0;
        const pill = document.createElement('span');
        pill.className = 'filter-pill';
        pill.setAttribute('role', 'button');
        pill.setAttribute('aria-pressed', state !== 0 ? 'true' : 'false');
        pill.setAttribute('title', 'Click to toggle filter');
        pill.tabIndex = 0;
        
        // Update visual state
        if (state === 1) {
            pill.classList.add('included');
            pill.setAttribute('data-state', 'included');
        } else if (state === -1) {
            pill.classList.add('excluded');
            pill.setAttribute('data-state', 'excluded');
        }
        
        // Add icon based on state
        const icon = document.createElement('i');
        icon.className = 'fas';
        if (state === 1) {
            icon.className += ' fa-check';
        } else if (state === -1) {
            icon.className += ' fa-times';
        }
        
        const text = document.createElement('span');
        text.textContent = label;
        
        pill.appendChild(icon);
        pill.appendChild(text);
        
        const updateState = (newState) => {
            if (newState === 0) {
                filterMap.delete(label);
                pill.className = 'filter-pill';
                pill.setAttribute('data-state', '');
            } else {
                filterMap.set(label, newState);
                pill.className = `filter-pill ${newState === 1 ? 'included' : 'excluded'}`;
                pill.setAttribute('data-state', newState === 1 ? 'included' : 'excluded');
            }
            icon.className = `fas ${newState === 1 ? 'fa-check' : newState === -1 ? 'fa-times' : ''}`;
            pill.setAttribute('aria-pressed', newState !== 0 ? 'true' : 'false');
            renderCourses();
        };
        
        // Click handler
        pill.addEventListener('click', () => {
            const currentState = filterMap.get(label) || 0;
            const newState = currentState === 0 ? 1 : (currentState === 1 ? -1 : 0);
            updateState(newState);
        });
        
        // Keyboard handler
        pill.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                pill.click();
            }
        });
        
        container.appendChild(pill);
    }

    // Update renderFilters to use enhanced createFilterPill
    function renderFilters() {
        const assessmentTypeFilters = document.getElementById('assessmentTypeFilters');
        const workTypeFilters = document.getElementById('workTypeFilters');
        
        if (!assessmentTypeFilters || !workTypeFilters || !courses) {
            console.error('Required elements not found or courses not loaded');
            return;
        }

        const allAssessmentTypes = new Set();
        const allWorkTypes = new Set();

        courses.forEach(course => {
            if (course.assessments) {
                course.assessments.forEach(a => {
                    if (a.type) allAssessmentTypes.add(a.type);
                    if (a.groupwork) allWorkTypes.add(a.groupwork);
                });
            }
        });

        assessmentTypeFilters.innerHTML = '';
        Array.from(allAssessmentTypes).sort().forEach(t => 
            createFilterPill(t, assessmentTypeFilterState, assessmentTypeFilters)
        );
        
        workTypeFilters.innerHTML = '';
        Array.from(allWorkTypes).sort().forEach(w => 
            createFilterPill(w, workTypeFilterState, workTypeFilters)
        );
    }

    // Helper function to truncate text with ellipsis
    function truncateText(text, maxLength) {
        if (!text || text.length <= maxLength) return text;
        
        // Try to truncate at the last complete word
        let truncated = text.substr(0, maxLength);
        let lastSpace = truncated.lastIndexOf(' ');
        
        if (lastSpace > maxLength * 0.8) { // Only truncate at word if we don't lose too much text
            truncated = truncated.substr(0, lastSpace);
        }
        
        return truncated + '...';
    }
    </script>
</body>
</html>
